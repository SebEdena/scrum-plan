"use strict";const fs=require("fs"),{ipcMain:ipcMain,dialog:dialog}=require("electron"),io=require("socket.io-client"),connPath="./settings.json",credentialsRules={properties:["uri"]};let socket=null,serverSettings=null,view=null,channel_send=null,app=null;function init_client(e){(socket=io(serverSettings.uri,{path:"/scrum",autoConnect:!1,reconnection:!1})).on("error",e=>{sendAppError(e.description.code)}),socket.on("srvError",e=>{"DB_UNAVAILABLE"!==e&&sendAppError(e)}),e(null)}function sendAppError(e){let t="Error : an unknown error occured.";switch(e){case"ECONNRESET":t="Connection with server interrupted. The application will quit.";break;case"DB_CONN_LOST":t="Server lost connection with the database. The application will quit."}dialog.showMessageBox({title:"Scrum Assistant",type:"error",buttons:["Ok"],message:t},e=>{0===e&&app.quit()})}function needsNotification(e,t){return"projects"===e||!!global.data.current&&t.project===global.data.current.id}function fetch(e,t){return!!global.loaded[e]||(load(e),!1)}function load(e){let t={};global.data.current&&(t.project=global.data.current.id),socket.emit("load",{type:e,data:t})}function loaded(e,t){if(["user_stories","projects","sprints","us_sprints"].includes(e.type)){for(let t of e.data)global.data[e.type][t.id]=t;global.loaded[e.type]?t(!1):(global.loaded[e.type]=!0,t(!0))}else if(["post_its","dailys"].includes(e.type)){for(let t of e.data)global.data[data.type].hasOwnProperty(t.sprint)||(global.data[data.type][t.sprint]={}),global.data[data.type][t.sprint][t.id]=t;global.loaded[e.type]?t(!1):(global.loaded[e.type]=!0,t(!0))}else t(!1)}function create(e,t){global.data.current&&(t.project=global.data.current.id),socket.emit("create",{type:e,data:t})}function update_item(e,t,n){["user_stories","projects","sprints","us_sprints"].includes(t)&&(global.data[t][e.id]=e),["post_its","dailys"].includes(t)&&(global.data[t][e.sprint][e.id]=e),n()}function delete_item(e,t,n){["user_stories","projects","sprints","us_sprints"].includes(t)&&global.data[t].hasOwnProperty(e.id)&&delete global.data[t][e.id],["post_its","dailys"].includes(t)&&global.data[t].hasOwnProperty(e.sprint)&&global.data[t][e.sprint].hasOwnProperty(e.id)&&delete global.data[t][e.sprint][e.id],n()}function initSocketEvents(e){socket.on("loaded",e=>{loaded(e,t=>{e.data=null,channel_send.send("loaded",e),t&&channel_send.send("fetched",e)})}),socket.on("created",e=>{channel_send.send("created",e)}),socket.on("insert",e=>{needsNotification(e.type,e.data)&&update_item(e.data,e.type,()=>{channel_send.send("insert",e)})}),socket.on("update",e=>{needsNotification(e.type,e.data)&&update_item(e.data,e.type,()=>{channel_send.send("update",e)})}),socket.on("delete",e=>{needsNotification(e.type,e.data)&&delete_item(e.data,e.type,()=>{channel_send.send("delete",e)})}),socket.on("dbError",e=>{needsNotification(e.type,e.data)&&channel_send.send("error",e)}),e(null)}ipcMain.on("create",(e,t)=>{create(t.type,t.data)}),ipcMain.on("open_project",(e,t)=>{for(let e in global.data.projects)if(t.id===global.data.projects[e].id){global.data.current=global.data.projects[e];break}view.loadURL("file://"+__dirname+"/../app/html/workspace.html")}),ipcMain.on("fetch",(e,t)=>{fetch(t.type,t.data)&&channel_send.send("fetched",{type:t.type})}),ipcMain.on("load",(e,t)=>{load(t.type)}),ipcMain.on("update",(e,t)=>{global.data.current&&(t.data.project=global.data.current.id),socket.emit("update",t)}),ipcMain.on("delete",(e,t)=>{global.data.current&&(t.data.project=global.data.current.id),socket.emit("delete",t)}),module.exports={verify_credentials:function(e){fs.readFile(connPath,(t,n)=>{t&&e(t);try{serverSettings=JSON.parse(n);for(let t of credentialsRules.properties)if(!serverSettings.hasOwnProperty(t))return void e(new Error('Missing credential property "'+t+'"'));e(null)}catch(t){e(t)}})},init:function(e,t,n){view=e,channel_send=e.webContents,app=t,init_client(e=>{n(e)})},connect:function(e){socket.connect(),socket.on("connect_error",t=>{e(t)}),socket.on("srvError",t=>{"DB_UNAVAILABLE"===t&&e(t)}),socket.on("srvInfo",t=>{e(null)})},init_events:function(e){initSocketEvents(e)},disconnect:function(){socket.close()}};var require=function(e){return module.exports};