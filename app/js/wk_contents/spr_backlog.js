"use strict";let sp_drake=null,sp_window_height=0;$(document).ready(t=>{function e(e,a){let d=`<div class="col-xl-6 spr_user_story spr_us${e.us} ${1===e.locked?"locked":""} d-flex flex-row justify-content-around rounded" id="usp${e.id}">\n                        <p>US#${e.us} <small class="text-muted">Estimated: ${parseFloat(e.estimate)}</small></p>\n                    </div>`;t("#spr_us").append(t(d)),t("#usp"+e.id).data("us",e.us),t("#usp"+e.id).data("id",e.id),t("#usp"+e.id).data("estimate",new Decimal(e.estimate)),t("#usp"+e.id).data("locked",!!e.locked),a&&t(".spr_us"+e.us).tooltip({placement:"top",title:a.feature}),s(t("#usp"+e.id),e.sprint,null)}function a(e){let a=`\n            <div class="card pj_spr" id="spr_${e.id}">\n                <div class="card-header" role="tab" id="h${e.id}">\n                    <div class="row d-flex justify-content-between">\n                        <h3 class="m-0 col-xl-3">\n                            <a data-toggle="collapse" href="#c${e.id}" aria-expanded="true" aria-controls="c${e.id}">\n                                Sprint #${e.id}\n                            </a>\n                            ${e.current>=0?'<span class="badge badge-secondary">Current</span>':""}\n                        </h3>\n                        <h3 class="m-0 col-xl-3" id="left"></h3>\n                        <form class="form-inline m-0 col-xl-6">\n                            <div class="input-group-sm">\n                                <input type="number" class="form-control form-control-sm rounded" id="total_pts" name="points" placeholder="Total points" min="0" value="${parseFloat(e.points)}" required disabled>\n                            </div>\n                            <div class="dropdown">\n                                <button class="btn btn-secondary btn-sm dropdown-toggle" type="button" id="actions" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">\n                                    Actions\n                                </button>\n                                <div class="dropdown-menu dropdown-menu-right" aria-labelledby="actions">\n                                    <button type="button" class='dropdown-item' id='spr_total_edit'>Edit</button>\n                                    <button type="button" class='dropdown-item' id='spr_total_cancel' disabled>Cancel</button>\n                                    <button type="button" class='dropdown-item' id='spr_start' ${e.current>=0?"disabled":""}>Start Sprint</button>\n                                </div>\n                            </div>\n                        </form>\n                    </div>\n                </div>\n                <div id="c${e.id}" class="collapse" role="tabpanel" aria-labelledby="h${e.id}">\n                    <div class="card-body">\n                        <div class="d-flex flex-wrap spr_us_container">\n                        </div>\n                    </div>\n                </div>\n            </div>`;var s;t("#sprints_container").append(t(a)),t("#spr_"+e.id).data("spr_id",e.id).data("total",new Decimal(e.points)).data("pt_left",new Decimal(e.points)).data("status",e.current).find("#left").text("Left: "+parseFloat(e.points)),t("#spr_"+e.id).find("#total_pts").tooltip({placement:"top",title:"Total sprint points"}),t("#spr_"+e.id).find("#spr_total_edit").on("click",()=>{!function(e){let a=e.find("#spr_total_edit");"Edit"===a.text()?(a.text("Ok"),e.find("input, #spr_total_cancel").prop("disabled",!1),e.find("#total_pts").trigger("focus")):e.find("form").trigger("submit");e.find("form").validate({submitHandler:t=>{e.find("input, button").prop("disabled",!0);let a={id:e.data("spr_id"),points:parseFloat(t.points.value).toFixed(2)};ipcRenderer.send("update",{type:"sprint",data:a})},showErrors:function(e,a){t.each(a,function(e,a){t(a.element).tooltip("dispose").addClass("error").tooltip({placement:"top",title:a.message})})}})}(t("#spr_"+e.id))}),t("#spr_"+e.id).find("#spr_total_cancel").on("click",()=>{(s=t("#spr_"+e.id)).find("#spr_total_edit").text("Edit"),s.find("#spr_total_cancel").prop("disabled",!0),s.find("#total_pts").val(s.data("total").toNumber()).tooltip("dispose").tooltip({placement:"top",title:"Total sprint points"}).prop("disabled",!0)}),t("#spr_"+e.id).find("#spr_start").on("click",()=>{!function(e){t("#modal_start_sprint").find("h4").text("Start Sprint #"+e.data("spr_id")),t("#modal_start_sprint").find("form").validate({rules:{date_start:{valid_date:!0,valid_interval:!0},date_end:{valid_date:!0}},submitHandler:a=>{let s={id:e.data("spr_id"),start:moment(a.date_start.value,"DD/MM/Y HH:mm").toDate(),end:moment(a.date_end.value,"DD/MM/Y HH:mm").toDate(),import_old:t("#ck_import_sp").is(":checked")};t("#modal_start_sprint").modal("hide"),console.log(s)},errorElement:"div"}),t("#modal_start_sprint").modal("show")}(t("#spr_"+e.id))}),sp_drake.containers.push(t("#spr_"+e.id).find(".spr_us_container")[0])}function s(e,a,s){let i=null==a?t("#spr_us"):t("#spr_"+a).find(".spr_us_container"),r=null==s?t("#spr_us"):t("#spr_"+s).find(".spr_us_container");t(e).detach().appendTo(i),d(e,i,r,!1)}function d(e,a,s,d){if(!t(a).is(t(s))&&t(a).has(t(e))){let i=null,r=null;"spr_us"!==t(s).prop("id")&&((i=t(s).parents().closest(".pj_spr")).data("pt_left",Decimal.add(i.data("pt_left"),t(e).data("estimate"))),i.find("#left").text("Left: "+i.data("pt_left").toNumber()),i.find("#total_pts").attr("min",i.data("total").minus(i.data("pt_left")).toNumber())),"spr_us"!==t(a).prop("id")&&(r=(i=t(a).parents().closest(".pj_spr")).data("spr_id"),i.data("pt_left",Decimal.sub(i.data("pt_left"),t(e).data("estimate"))),i.find("#left").text("Left: "+i.data("pt_left").toNumber()),i.find("#total_pts").attr("min",i.data("total").minus(i.data("pt_left")).toNumber())),d&&ipcRenderer.send("update",{type:"usp_move",data:{id:t(e).data("id"),sprint:r}})}}t.datetimepicker.setDateFormatter("moment"),t.validator.addMethod("valid_date",(t,e)=>moment(t,"DD/MM/Y HH:mm").isValid(),"This date is invalid"),t.validator.addMethod("valid_interval",(e,a)=>""===e||""===t("#dtp_end").val()||moment(e,"DD/MM/Y HH:mm").isSameOrBefore(moment(t("#dtp_end").val(),"DD/MM/Y HH:mm")),"The interval is invalid"),t("#spr_us").data("spr_id",-1),sp_window_height=t(window).height(),t("#dtp_start").datetimepicker({format:"DD/MM/Y HH:mm",formatDate:"DD/MM/Y",formatTime:"HH:mm",step:15,onShow:function(e){this.setOptions({maxDate:!!t("#dtp_end").val()&&t("#dtp_end").val().split(" ")[0],maxTime:!!t("#dtp_end").val()&&t("#dtp_end").val().split(" ")[1]})}}),t("#dtp_end").datetimepicker({format:"DD/MM/Y HH:mm",formatDate:"DD/MM/Y",formatTime:"HH:mm",step:15,onShow:function(e){this.setOptions({minDate:!!t("#dtp_start").val()&&t("#dtp_start").val().split(" ")[0],minTime:!!t("#dtp_start").val()&&t("#dtp_start").val().split(" ")[1]})}}),t("#modal_start_sprint").on("hidden.bs.modal",()=>{t("#modal_start_sprint").find(".dtp").datetimepicker("reset"),t("#dtp_start").datetimepicker("setOptions",{maxDate:!1,maxTime:!1}),t("#dtp_end").datetimepicker("setOptions",{minDate:!1,minTime:!1}),t("#modal_start_sprint").find("#ck_import_sp").prop("checked",!1),t("#modal_start_sprint").find("form").validate().destroy()}),ipcRenderer.send("fetch",{type:"user_stories"}),ipcRenderer.on("fetched",(s,i)=>{if(!i.err&&!~asked_fetch.spr_backlog.indexOf(i.type)){switch(i.type){case"user_stories":ipcRenderer.send("fetch",{type:"us_sprints"});break;case"us_sprints":ipcRenderer.send("fetch",{type:"sprints"});break;case"sprints":(sp_drake=dragula({accepts:(e,a,s,d)=>{if(t(a).is(t(s))||"spr_us"===t(a).prop("id"))return!0;let i=t(a).parents().closest(".pj_spr");return Decimal.sub(i.data("pt_left"),t(e).data("estimate")).isPositive()},moves:function(e,a,s,d){return t(e).hasClass("spr_user_story")&&("spr_us"===t(a).prop("id")||t(a).parents().closest(".pj_spr").data("status")<0)},invalid:function(e,a){return t(e).hasClass("locked")}})).containers.push(t("#spr_us")[0]),sp_drake.on("drop",(t,e,a,s)=>{d(t,e,a,!0)}),t(document).on("mousemove",function(e){let a=e.pageY-t(".content-page#spr_backlog").scrollTop(),s=.15*sp_window_height,d=sp_window_height-.15*sp_window_height;if(1==e.which&&sp_drake.dragging&&(a<s||a>d)){let a=e.clientY-sp_window_height/2;a*=.1,t(".pane").scrollTop(a+t(".pane").scrollTop())}}),function(){let t=remote.getGlobal("data").sprints;for(let e in t)a(t[e])}(),function(){let t=remote.getGlobal("data").user_stories,a=remote.getGlobal("data").us_sprints;for(let s in a){let d=a[s];e(d,t[d.us])}}()}asked_fetch.spr_backlog.push(i.type)}}),ipcRenderer.on("created",(t,e)=>{e.err&&"sprint"===e.type&&dialog.showMessageBox({title:"Scrum Assistant",type:"error",buttons:["ok"],message:"Unable to create a new sprint."},t=>{})}),ipcRenderer.on("insert",(s,d)=>{"sprints"===d.type&&0===t("#spr_"+d.data.id).length&&(a(d.data),t("#spr_"+d.data.id).find("#spr_total_edit").trigger("click")),"us_sprints"===d.type&&0===t("#usp"+d.data.us).length&&e(d.data,remote.getGlobal("data").user_stories[d.data.us])}),ipcRenderer.on("delete",(e,a)=>{if("sprints"===a.type){for(;t("#spr_"+a.data.id).find(".spr_user_story").length;);t("#spr_"+a.data.id).remove()}"us_sprints"===a.type&&(t("#spr_"+a.data.sprint).data("pt_left",t("#spr_"+a.data.sprint).data("pt_left").add(a.data.estimate)),t("#spr_"+a.data.sprint).find("#left").text("Left: "+t("#spr_"+a.data.sprint).data("pt_left")),t("#usp"+a.data.id).remove())}),ipcRenderer.on("update",(a,d)=>{if("us_sprints"===d.type)if(0===t("#usp"+d.data.id).length)e(d.data,remote.getGlobal("data").user_stories[d.data.us]);else{let e=Decimal.sub(d.data.estimate,t("#usp"+d.data.id).data("estimate")),a=t("#usp"+d.data.id).parents().closest(".pj_spr");if(t("#usp"+d.data.id).data("estimate",parseFloat(d.data.estimate)),a.data("spr_id")!==d.data.sprint)s(t("#usp"+d.data.id),d.data.sprint,a.data("id"));else if(null!=d.data.sprint){let a=t("#spr_"+d.data.sprint);a.data("pt_left",t("#spr_"+d.data.sprint).data("pt_left").minus(e)),a.find("#left").text("Left: "+t("#spr_"+d.data.sprint).data("pt_left")),a.find("#total_pts").attr("min",Decimal.sub(a.data("total"),a.data("pt_left")).toNumber())}t("#usp"+d.data.id).html(`<p>US#${d.data.us} <small class="text-muted">Estimated: ${parseFloat(d.data.estimate)}</small></p>`)}if("sprints"===d.type){let e=t("#spr_"+d.data.id),a=Decimal.sub(d.data.points,e.data("total"));e.data("total",new Decimal(d.data.points)),e.data("pt_left",Decimal.add(e.data("pt_left"),a)),e.find("#total_pts").val(e.data("total").toNumber()).attr("min",Decimal.sub(e.data("total"),e.data("pt_left")).toNumber()),e.data("status",d.data.status),e.find("#left").text("Left: "+e.data("pt_left").toNumber()),e.find("#spr_total_edit").text("Edit").prop("disabled",!1),e.find("#actions").prop("disabled",!1)}"user_stories"===d.type&&t(".spr_us"+d.data.id).tooltip("dispose").tooltip({placement:"top",title:d.data.feature})}),ipcRenderer.on("error",(t,e)=>{console.error(e)}),t(window).resize(()=>{sp_window_height=t(window).height()}),t("#create_sp").on("click",()=>{ipcRenderer.send("create",{type:"sprint",data:{}})}),t("#delete_sp").on("click",()=>{!function(){let e=t(".pj_spr:not(#spr_us)");return!!e.length&&!t.grep(e.last().find(".spr_user_story"),(e,a)=>t(e).data("locked")).length}()?dialog.showMessageBox({title:"Scrum Assistant",type:"error",buttons:["Ok"],message:"Unable to delete the last sprint."},t=>{}):dialog.showMessageBox({title:"Scrum Assistant",type:"info",buttons:["No","Yes"],message:"Do you really want to delete the last sprint ?",defaultId:0},e=>{1===e&&ipcRenderer.send("delete",{type:"sprint",data:{id:t(".pj_spr:not(#spr_us)").last().data("spr_id")}})})})});