"use strict";let tmp_us=[],locked={};$(document).ready(e=>{function t(t,s){let n=`\n            <div class="container user_story rounded" id="us${t.id}">\n                <div class="d-flex justify-content-between align-items-end">\n                    <div><h4>User Story #${t.id}</h4></div>\n                    <div>\n                        <span class="btn-group">\n                            <button type="button" id="ok" class="btn btn-secondary">Edit</button>\n                            <button type="button" id="del" class="btn btn-danger" ${s?"disabled":""}>Delete</button>\n                        </span>\n                    </div>\n                </div>\n                <form>\n                    <div class="form-row">\n                        <div class="col-md-10">\n                            <label for="feat">Feature</label>\n                            <input type="text" class="form-control" id="feat" name="feature" placeholder="Enter story feature" value="${t.feature}" maxlength="256" required disabled>\n                        </div>\n                        <div class="col-md-2">\n                            <label for="est">Estimate</label>\n                            <input type="number" class="form-control" id="est" name="estimate" maxlength="256" min="0" value="${adjust_display(t.estimate)}" required disabled>\n                        </div>\n                    </div>\n                    <div class="form-group">\n                        <label class="pt-2" for="desc">Feature Logs</label>\n                        <textarea class="form-control mb-2" id="desc" name="description" rows="3" placeholder="Feature logs" maxlength="512" disabled>${t.logs}</textarea>\n                    </div>\n                </form>\n            </div>\n        `;e("#features").append(e(n)),e("#us"+t.id).data("id",t.id),a(e("#us"+t.id)),d(t.id,e("#us"+t.id))}function s(e=null){let t=remote.getGlobal("data").us_sprints;for(let s in t){let a=t[s];null!=e&&a.us!==e||(locked.hasOwnProperty(a.us)||(locked[a.us]=!1),locked[a.us]=locked[a.us]||a.locked)}}function a(t){t.find("#del").on("click",()=>{if("Delete"===t.find("#del").text())n(t,!1);else{let e=remote.getGlobal("data").user_stories;for(let s in e)if(e[s].id===t.data("id")){t.find("#feat").val(e[s].feature),t.find("#desc").val(e[s].logs),t.find("#est").val(parseFloat(e[s].estimate));break}t.find("#ok").text("Edit").removeClass("btn-success").addClass("btn-secondary"),locked[t.data("id")]&&t.find("#del").prop("disabled",!0),t.find("#del").text("Delete"),t.find("input, textarea").prop("disabled",!0)}}),t.find("#ok").on("click",()=>{"Ok"===t.find("#ok").text()?(t.find("form").trigger("submit"),t.find("#del").text("Delete")):(locked[t.data("id")]?t.find("input:not(#est), textarea").prop("disabled",!1):t.find("input, textarea").prop("disabled",!1),t.find("#ok").text("Ok"),t.find("#del").text("Cancel"),locked[t.data("id")]&&t.find("#del").prop("disabled",!1),t.find("#ok").removeClass("btn-secondary").addClass("btn-success"),t.find('input[name="feature"]').trigger("focus"))}),t.find("form").validate({submitHandler:s=>{t.find("#ok").text("Edit").removeClass("btn-success").addClass("btn-secondary"),t.find("input, textarea, button").prop("disabled",!0);let a=function(e){let t=e.data("id"),s=remote.getGlobal("data").us_sprints,a=remote.getGlobal("data").sprints,d={};Object.keys(a).forEach(e=>{d[e]=new Decimal(a[e].points)});let n=-1,i=-1;for(let a in s){let r=s[a];null==r.sprint||null==d[r.sprint]||-1!==n&&r.sprint!==n||(r.us===t?1===r.locked?d[r.sprint]=null:(d[r.sprint]=d[r.sprint].minus(e.find("#est").val()),n=r.sprint,i=r.id):d[r.sprint]=d[r.sprint].minus(r.estimate))}return{update_ok:!(n>=0)||d[n].isPositive(),us_sprint:i}}(t);a.update_ok?function(e,t){let s={feature:t.feature.value,logs:t.description.value,estimate:parseFloat(t.estimate.value.replace(",",".")).toFixed(2),id:e.data("id")};ipcRenderer.send("update",{type:"us",data:s})}(t,s):function(t,s){let a=remote.getGlobal("data").user_stories[t.data("id")],d=remote.getGlobal("data").us_sprints[s],n=remote.getGlobal("data").sprints[d.sprint];dialog.showMessageBox(remote.getCurrentWindow(),{title:"Scrum Assistant",type:"info",buttons:["Revert","Remove US from sprint","Add sprint points"],defaultId:2,message:`The estimate change in this user story (#${a.id}) causes sprint (#${n.id}) to contain more story points than it should. \nWhat do you want to do ?`},t=>{switch(t){case 0:i(a);break;case 1:!function(t,s){ipcRenderer.send("update",{type:"usp_remove_overflow",data:{id:s.id,us:t.id,feature:t.feature,logs:t.logs,estimate:e("#us"+t.id).find("#est").val()}})}(a,d);break;case 2:!function(t,s,a){let d=new Decimal(a.points).minus(t.estimate).plus(e("#us"+t.id).find("#est").val()).toNumber(),n={id:s.id,sprint:s.sprint,us:t.id,sp_points:d,feature:t.feature,logs:t.logs,estimate:e("#us"+t.id).find("#est").val()};ipcRenderer.send("update",{type:"usp_update_overflow",data:n})}(a,d,n)}})}(t,a.us_sprint)},errorElement:"div"})}function d(t,s){for(let a of e(".user_story:not(#us"+t+")"))if(t<e(a).data("id"))return void s.detach().insertBefore(e(a));e(".user_story:not(#us"+t+")").length>0&&s.detach().insertAfter(e(".user_story:not(#us"+t+")").last())}function n(e,t){t?e.find("input, textarea, button").prop("disabled",!0):e.find("button").prop("disabled",!0),dialog.showMessageBox({title:"Scrum Assistant",type:"info",buttons:["Yes","No"],message:"Delete this User Story ?"},s=>{0===s?t?e.remove():ipcRenderer.send("delete",{type:"us",data:{id:e.data("id"),feature:e.find("#feat").val()}}):t?e.find("input, textarea, button").prop("disabled",!1):e.find("button").prop("disabled",!1)})}function i(t){e("#us"+t.id).find("#est").val(parseFloat(t.estimate)),e("#us"+t.id).find("#ok").text("Ok"),e("#us"+t.id).find("#del").text("Cancel"),e("#us"+t.id).find("#ok").removeClass("btn-secondary").addClass("btn-success"),e("#us"+t.id).find("input, textarea, button").prop("disabled",!1),e("#us"+t.id).find('input[name="feature"]').trigger("focus")}ipcRenderer.send("fetch",{type:"us_sprints"}),ipcRenderer.on("fetched",(e,a)=>{if(!a.err&&!~asked_fetch.prod_backlog.indexOf(a.type)){switch(a.type){case"us_sprints":s(),ipcRenderer.send("fetch",{type:"user_stories"});break;case"user_stories":!function(){let e=remote.getGlobal("data").user_stories;for(let s in e)t(e[s],locked[s])}()}asked_fetch.prod_backlog.push(a.type)}}),ipcRenderer.on("created",(t,s)=>{if("us"===s.type)if("ok"===s.status){0===e("#us"+s.data.id).length?function(e,t){s=t.tmp_ticket,tmp_us[s]=!1,d(t.id,e),e.data("id",t.id),e.find("button").off("click"),e.find("h4").text("User Story #"+t.id),e.prop("id","us"+t.id).removeClass("new_user_story").addClass("user_story"),e.find("form").data("validator").destroy(),a(e),e.find("button").prop("disabled",!1),e.find("#est").val(adjust_display(t.estimate));var s}(e("#us_tmp"+s.data.tmp_ticket),s.data):e("#us_tmp"+s.data.tmp_ticket).remove();let t={title:"Scrum Assistant",type:"info",buttons:["Ok"]};t.message="The US #"+s.data.id+' : "'+s.data.feature+'" has been created successfully !',dialog.showMessageBox(t)}else{let t={title:"Scrum Assistant",type:"error",buttons:["Retry","Cancel"]};t.message="The US #"+s.data.id+' : "'+s.data.feature+'" could not be created.',dialog.showMessageBox(t,t=>{0===t?e("#us_tmp"+s.data.tmp_ticket).find("form").trigger("submit"):item.find("button").prop("disabled",!1)})}}),ipcRenderer.on("update",(t,a)=>{"user_stories"===a.type&&(e("#us"+a.data.id).find("#feat").val(a.data.feature),e("#us"+a.data.id).find("#desc").val(a.data.logs),e("#us"+a.data.id).find("#est").val(adjust_display(a.data.estimate)),locked[a.data.id]?e("#us"+a.data.id).find("button:not(#del)").prop("disabled",!1):e("#us"+a.data.id).find("button").prop("disabled",!1)),"us_sprints"===a.type&&s(a.data.us)}),ipcRenderer.on("delete",(t,s)=>{"user_stories"===s.type&&(e("#us"+s.data.id).remove(),delete locked[s.data.id])}),ipcRenderer.on("insert",(s,a)=>{"user_stories"===a.type&&0===e("#us"+a.data.id).length&&(locked[a.data.id]=!1,t(a.data,!1)),"us_sprints"===a.type&&(locked[a.data.us]=locked[a.data.us]||!!a.data.locked)}),ipcRenderer.on("error",(t,s)=>{"us"===s.type&&(i(remote.getGlobal("data").user_stories[s.data.id]),e("#us"+s.data.id).find("button").prop("disabled",!1))}),e("#create_us").on("click",()=>{if(0!==e("#us_new").length)return void e("#us_new").find('input[name="feature"]').trigger("focus");e("#features").append(e('\n            <div class="container new_user_story rounded" id="us_new">\n                <div class="d-flex justify-content-between align-items-end">\n                    <div><h4>New User Story</h4></div>\n                    <div>\n                        <span class="btn-group">\n                            <button type="button" id="ok" class="btn btn-success">Ok</button>\n                            <button type="button" id="del" class="btn btn-danger">Delete</button>\n                        </span>\n                    </div>\n                </div>\n                <form>\n                    <div class="form-row">\n                        <div class="col-md-10">\n                            <label for="feat">Feature</label>\n                            <input type="text" class="form-control" id="feat" name="feature" placeholder="Enter story feature" maxlength="256" required>\n                        </div>\n                        <div class="col-md-2">\n                            <label for="est">Estimate</label>\n                            <input type="number" class="form-control" id="est" name="estimate" maxlength="256" min="0" value="0" required>\n                        </div>\n                    </div>\n                    <div class="form-group">\n                        <label class="pt-2" for="desc">Feature Logs</label>\n                        <textarea class="form-control mb-2" id="desc" name="description" rows="3" placeholder="Feature logs" maxlength="512"></textarea>\n                    </div>\n                </form>\n            </div>\n        ')),function(t){t.find('input[name="feature"]').trigger("focus"),t.find("#del").on("click",()=>{n(t,!0)}),t.find("#ok").on("click",()=>{e(t).find("form").trigger("submit")}),t.find("form").validate({submitHandler:e=>{t.find("#ok").text("Edit").removeClass("btn-success").addClass("btn-secondary"),t.find("input, textarea, button").prop("disabled",!0);let s=function(){let e=-1;for(e in tmp_us)if(!1===tmp_us[e])return tmp_us[e]=!0,e;return e=tmp_us.length,tmp_us[e]=!0,e}();t.prop("id","us_tmp"+s);let a={feature:e.feature.value,logs:e.description.value,estimate:parseFloat(e.estimate.value.replace(",",".")).toFixed(2),tmp_ticket:s};ipcRenderer.send("create",{type:"us",data:a})},errorElement:"div"})}(e("#us_new"))})});